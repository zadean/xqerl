# this workflow runs 
# 1. when we merge a pull request into the main branch
# 2. push an annotated tag on the main branch
# The main checks are done on pushes to feature branches 
name: build check release
on:
  push:
    branches: 
      - 'main'
    tags:
      - 'v*.*.*'
jobs:
  vsn_checks:
    runs-on: ubuntu-latest
    steps:
    - name: checkout repo
      uses: actions/checkout@v3
    - name: set env
      run: |
        grep -qoP 'v\d+\.\d+\.\d+' rebar.config
        grep -qoP '\d+\.\d+\.\d+' src/xqerl.app.src
        REBAR_RELEASE="$(grep -oP 'v\d+\.\d+\.\d+' rebar.config)"
        APP_VSN="$(grep -oP '\d+\.\d+\.\d+' src/xqerl.app.src)"
        echo "rebar_release=$REBAR_RELEASE" >> $GITHUB_ENV
        echo "app_vsn=$APP_VSN" >> $GITHUB_ENV
    - name: when branch do some inital checks
      if:  ${{ github.ref_type == 'branch'  }} 
      run: |
        echo ${{github.ref_name}}
        echo 'check: rebar_release and app_vsn have the same version number'
        ${{ env.rebar_release == format('{0}{1}','v', env.app_vsn ) }}
        echo " - rebar_release: ${{ env.rebar_release}} "
        echo " - xqerl app vsn: ${{ env.app_vsn }} "
    - name: when tag do some inital checks
      if:  ${{ github.ref_type == 'tag'  }} 
      run: |
        echo " - release version: ${{github.ref_name}}"
        # - derive NOTE from the annotated tag message
        NOTE="$(git tag -l --format='%(contents:subject)' ${{github.ref_name}} )"
        echo " - release subject: ${NOTE}"
        echo 'check: rebar_release and app_vsn have the same version number'
        ${{ env.rebar_release == format('{0}{1}','v', env.app_vsn ) }} 
        echo 'check: tag version is the same as rebar release version'
        ${{ env.rebar_release == github.ref_name }} 
        echo 'check: annotated tag  will have tag message '
        # A pushed tag may be lightwieght tag therefor no subject
        [ ! -z "${NOTE}" ] || echo 'ERR: lightweight tag pushed. use annotated tag to create release'
        [ ! -z "${NOTE}" ]
  build_check:
    needs: vsn_checks
    uses: ./.github/workflows/build-check.yml
  tar_release:
    if: ${{ github.ref_type == 'tag' }}
    needs: build_check
    uses: ./.github/workflows/xqerl-slim-tar.yml
  container_release:
    needs: vsn_checks
    if: ${{ github.ref_type == 'tag' }}
    uses: ./.github/workflows/xqerl-alpine-image.yml
